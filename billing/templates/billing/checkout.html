{% extends "base.html" %}
{% load static %}

{% block title %}Checkout{% endblock title %}

{% block content %}
<div class="section">
    <div class="container">
        <div class="title-1"><i class="fa fa-credit-card" aria-hidden="true"></i>Checkout</div>
        <div class="title-line mb-5"></div>

        {% if error %}
        <div class="alert alert-danger" role="alert">
            {{ error }}
        </div>
        {% endif %}

        {% if object %}
        <div class="row">
            <div class="col-md-8">
                <div class="card mb-4" style="box-shadow: 0px 2px 5px 2px rgba(0, 0, 0, 0.3);">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in cart.products.all %}
                                <tr>
                                    <td>{{ product.title }}</td>
                                    <td>${{ product.price }}</td>
                                </tr>
                                {% endfor %}
                                <tr>
                                    <td><strong>Subtotal</strong></td>
                                    <td><strong>${{ cart.subtotal }}</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Tax (8%)</strong></td>
                                    <td><strong>${{ cart.tax_total }}</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>Shipping</strong></td>
                                    <td><strong>${{ object.shipping_total }}</strong></td>
                                </tr>
                                <tr class="bg-light">
                                    <td><strong>Total</strong></td>
                                    <td><strong>${{ object.total }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card" style="box-shadow: 0px 2px 5px 2px rgba(0, 0, 0, 0.3);">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Payment Information</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{% url 'payment' %}" id="payment-form">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="card-element">Credit or debit card</label>
                                <div id="card-element" class="form-control" style="height: 40px; padding-top: 7px;">
                                    <!-- Stripe Elements will create form elements here -->
                                </div>
                                <div id="card-errors" role="alert" class="text-danger mt-2"></div>
                            </div>
                            <button type="submit" class="btn btn-success btn-block btn-lg" id="submit-button">
                                Pay ${{ object.total }}
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-warning">
            <p>Your cart is empty. <a href="{% url 'products' %}">Continue Shopping</a></p>
        </div>
        {% endif %}
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    var stripe = Stripe('{{ stripe_publishable_key }}');
    var elements = stripe.elements();

    var style = {
        base: {
            color: '#32325d',
            fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
            fontSmoothing: 'antialiased',
            fontSize: '16px',
            '::placeholder': {
                color: '#aab7c4'
            }
        },
        invalid: {
            color: '#fa755a',
            iconColor: '#fa755a'
        }
    };

    var card = elements.create('card', {style: style});
    card.mount('#card-element');

    card.on('change', function(event) {
        var displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });

    var form = document.getElementById('payment-form');
    form.addEventListener('submit', function(event) {
        event.preventDefault();

        var submitButton = document.getElementById('submit-button');
        submitButton.disabled = true;
        submitButton.textContent = 'Processing...';

        stripe.createToken(card).then(function(result) {
            if (result.error) {
                var errorElement = document.getElementById('card-errors');
                errorElement.textContent = result.error.message;
                submitButton.disabled = false;
                submitButton.textContent = 'Pay ${{ object.total|default:"0" }}';
            } else {
                var hiddenInput = document.createElement('input');
                hiddenInput.setAttribute('type', 'hidden');
                hiddenInput.setAttribute('name', 'stripeToken');
                hiddenInput.setAttribute('value', result.token.id);
                form.appendChild(hiddenInput);
                form.submit();
            }
        });
    });
</script>
{% endblock %}

